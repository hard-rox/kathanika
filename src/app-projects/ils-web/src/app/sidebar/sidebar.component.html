<!-- Mobile backdrop -->
@if (isMobileOpen()) {
    <div
        class="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden"
        (keydown)="closeMobileSidebar()"
        aria-hidden="true">
    </div>
}

<!-- Hover submenu for collapsed sidebar with children - positioned outside sidebar -->
@if (isCollapsed() && !isMobileOpen() && hoveredItemIndex() !== null && navigationItems()[hoveredItemIndex()!].children) {
    <div class="fixed bg-white border border-gray-200 rounded-lg shadow-xl z-60 min-w-48 py-2"
         [style.left.px]="60"
         [style.top.px]="116 + (hoveredItemIndex()! * 44)"
         (mouseenter)="onSubmenuEnter()"
         (mouseleave)="onSubmenuLeave()">
        <div class="px-3 py-2 border-b border-gray-100">
            <span class="text-sm font-semibold text-gray-800">{{ navigationItems()[hoveredItemIndex()!].label }}</span>
        </div>
        @for (child of navigationItems()[hoveredItemIndex()!].children; track child.route) {
            <a
                [routerLink]="child.route!"
                routerLinkActive="bg-blue-50 text-blue-700"
                class="flex items-center px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 transition-colors duration-200"
                (click)="navigateTo(child.route!)">
        <span class="material-symbols-rounded text-lg mr-3 flex-shrink-0" aria-hidden="true">
          {{ child.icon }}
        </span>
                <span class="truncate">{{ child.label }}</span>
            </a>
        }
    </div>
}

<!-- Tooltip for single route items in collapsed sidebar - positioned outside sidebar -->
@if (isCollapsed() && !isMobileOpen() && hoveredItemIndex() !== null && !navigationItems()[hoveredItemIndex()!].children) {
    <div class="fixed bg-gray-800 text-white text-sm px-2 py-1 rounded z-60 whitespace-nowrap"
         [style.left.px]="60"
         [style.top.px]="124 + (hoveredItemIndex()! * 44)">
        {{ navigationItems()[hoveredItemIndex()!].label }}
    </div>
}

<!-- Sidebar -->
<aside
    class="fixed left-0 top-16 h-[calc(100vh-4rem)] bg-white border-r border-gray-200 shadow-lg z-40 transition-all duration-300 ease-in-out"
    [class.translate-x-0]="isMobileOpen()"
    [class.-translate-x-full]="!isMobileOpen()"
    [class.lg:translate-x-0]="true"
    [class.w-64]="!isCollapsed() || isMobileOpen()"
    [class.w-16]="isCollapsed() && !isMobileOpen()"
    (keydown.escape)="closeMobileSidebar()">

    <!-- Sidebar header -->
    <div class="flex items-center p-4 border-b border-gray-200"
         [class.justify-center]="isCollapsed() && !isMobileOpen()">
        @if (!isCollapsed() || isMobileOpen()) {
            <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-theme-gunmetal rounded-lg flex items-center justify-center">
                    <span class="text-white font-bold text-sm">K</span>
                </div>
                <span class="text-lg font-semibold text-gray-800">Library</span>
            </div>
        } @else {
            <div class="w-8 h-8 bg-theme-gunmetal rounded-lg flex items-center justify-center">
                <span class="text-white font-bold text-sm">K</span>
            </div>
        }
    </div>

    <!-- Navigation -->
    <nav class="flex-1 overflow-y-auto py-4">
        <ul class="space-y-1 px-3">
            @for (item of navigationItems(); track $index) {
                <li>
                    <!-- Parent menu items (with or without children) -->
                    @if (item.children) {
                        <!-- Parent item with children - no route, toggle on click -->
                        <button
                            (click)="toggleParentMenu($index)"
                            (mouseenter)="onMenuItemHover($index)"
                            (mouseleave)="onMenuItemLeave()"
                            class="flex items-center w-full px-3 py-2 text-sm font-medium text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-200"
                            [class.justify-center]="isCollapsed() && !isMobileOpen()"
                            [attr.aria-expanded]="item.isExpanded"
                            [attr.aria-label]="item.label"
                            type="button">
              
              <span class="material-symbols-rounded text-xl flex-shrink-0"
                    [class.mr-3]="!isCollapsed() || isMobileOpen()"
                    aria-hidden="true">
                {{ item.icon }}
              </span>

                            @if (!isCollapsed() || isMobileOpen()) {
                                <span class="truncate flex-1 text-left">{{ item.label }}</span>
                                <!-- Expand/collapse icon -->
                                <span class="material-symbols-rounded text-lg transition-transform duration-200"
                                      [class.rotate-180]="item.isExpanded"
                                      aria-hidden="true">
                  expand_more
                </span>
                            }
                        </button>

                        <!-- Regular submenu for expanded state -->
                        @if (item.isExpanded && (!isCollapsed() || isMobileOpen())) {
                            <ul class="mt-1 ml-6 space-y-1 overflow-hidden transition-all duration-300 ease-in-out">
                                @for (child of item.children; track child.route) {
                                    <li>
                                        <a
                                            [routerLink]="child.route!"
                                            routerLinkActive="bg-blue-50 text-blue-700 border-l-2 border-blue-700"
                                            class="flex items-center px-3 py-2 text-sm text-gray-600 rounded-lg hover:bg-gray-100 transition-colors duration-200 ml-2"
                                            (click)="navigateTo(child.route!)">
                      <span class="material-symbols-rounded text-lg mr-3 flex-shrink-0" aria-hidden="true">
                        {{ child.icon }}
                      </span>
                                            <span class="truncate">{{ child.label }}</span>
                                        </a>
                                    </li>
                                }
                            </ul>
                        }
                    } @else {
                        <!-- Single menu item with route -->
                        <a
                            [routerLink]="item.route!"
                            routerLinkActive="bg-blue-50 text-blue-700 border-r-2 border-blue-700"
                            class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-200"
                            [class.justify-center]="isCollapsed() && !isMobileOpen()"
                            (mouseenter)="onMenuItemHover($index)"
                            (mouseleave)="onMenuItemLeave()"
                            (click)="navigateTo(item.route!)">
              
              <span class="material-symbols-rounded text-xl flex-shrink-0"
                    [class.mr-3]="!isCollapsed() || isMobileOpen()"
                    aria-hidden="true">
                {{ item.icon }}
              </span>

                            @if (!isCollapsed() || isMobileOpen()) {
                                <span class="truncate">{{ item.label }}</span>
                            }
                        </a>
                    }
                </li>
            }
        </ul>
    </nav>

    <!-- Sidebar footer -->
    <div class="border-t border-gray-200 p-4"
         [class.text-center]="isCollapsed() && !isMobileOpen()">
        @if (!isCollapsed() || isMobileOpen()) {
            <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
                    <span class="material-symbols-rounded text-gray-600 text-sm" aria-hidden="true">help</span>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-700 truncate">Help & Support</p>
                    <p class="text-xs text-gray-500 truncate">Get assistance</p>
                </div>
            </div>
        } @else {
            <button
                class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center hover:bg-gray-400 transition-colors group relative"
                aria-label="Help & Support">
                <span class="material-symbols-rounded text-gray-600 text-sm" aria-hidden="true">help</span>
                <!-- Tooltip -->
                <div
                    class="absolute left-12 bottom-0 bg-gray-800 text-white text-sm px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50 whitespace-nowrap">
                    Help & Support
                </div>
            </button>
        }
    </div>
</aside>